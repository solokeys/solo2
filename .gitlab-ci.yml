stages:
  - pull-github
  - build
  - deploy

variables:
  #Repo for shared scripts (pull.sh release.sh, nightly_upload.sh):
  SCRIPTS_REPO: git@git.dotplex.com:nitrokey/gitlab-ci.git
  GIT_STRATEGY: clone            #This seems to have no effect also set in webinterface
  GIT_DEPTH: 0                    #This seems to have no effect also set in webinterface
  GIT_SUBMODULE_STRATEGY: recursive #This seems to have no effect also set in webinterfac

pull:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $CI_COMMIT_BRANCH == "docker-build"'
  image: nitrokey/ci-pull:latest
  tags:
    - docker
  stage: pull-github
  before_script:
    - ./ci-scripts/copy_common_scripts_key.sh
    - export SCRIPTS_DIR=$(mktemp -d)
    - git clone -q --depth 1 $SCRIPTS_REPO $SCRIPTS_DIR
  script:
    - chmod +x  $SCRIPTS_DIR/ci-scripts/pull.sh
    - $SCRIPTS_DIR/ci-scripts/pull.sh nitrokey solo2

size-nk3xn:
  image: nitrokey3:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
  tags:
    - docker
  stage: build
  script:
    - make -C $(RUNNER) size BOARD=nk3xn

size-nk3am:
  image: nitrokey3:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
  tags:
    - docker
  stage: build
  script:
    - make -C $(RUNNER) size BOARD=nk3am

build-nk3xn:
  image: nitrokey3:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
  tags:
    - docker
  stage: build
  script:
    - make -C $(RUNNER) build BOARD=nk3xn


build-nk3am:
  image: nitrokey3:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
  tags:
    - docker
  stage: build
  script:
    - make -C $(RUNNER) build BOARD=nk3am

objcopy-nk3am:
  image: nitrokey3:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
  tags:
    - docker
  stage: build
  script:
    - make -C $(RUNNER) objcopy BOARD=nk3am
  artifacts:
    paths:
      - ./runners/lpc55/firmware-*.bin

objcopy-nk3xn:
  image: nitrokey3:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
  tags:
    - docker
  stage: build
  script:
    - make -C $(RUNNER) objcopy BOARD=nk3xn
  artifacts:
    paths:
      - ./runners/lpc55/firmware-*.bin

upload-nightly:
  stage: deploy
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  tags:
    - docker
  image: nitrokey/ci-nightly-upload:latest
  before_script:
    - apt-get update -y
    - apt-get upgrade -y
    - ./ci-scripts/copy_common_scripts_key.sh
    - export SCRIPTS_DIR=$(mktemp -d)
    - git clone -q --depth 1 $SCRIPTS_REPO $SCRIPTS_DIR
  script:
    - cp ./runners/lpc55/firmware-*.bin artifacts
    - chmod +x $SCRIPTS_DIR/ci-scripts/nightly_upload.sh
    - $SCRIPTS_DIR/ci-scripts/nightly_upload.sh

deploy-release:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
  image: nitrokey/ci-publish-git:latest
  tags:
    - docker
  stage: deploy
  before_script:
    - apt-get update -y
    - apt-get upgrade -y
    - ./ci-scripts/copy_common_scripts_key.sh
    - export SCRIPTS_DIR=$(mktemp -d)
    - git clone -q --depth 1 $SCRIPTS_REPO $SCRIPTS_DIR
  script:
    - cp ./runners/lpc55/firmware-*.bin artifacts
    - chmod +x $SCRIPTS_DIR/ci-scripts/release.sh
    - $SCRIPTS_DIR/ci-scripts/release.sh